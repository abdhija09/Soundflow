<%- include('./partials/head.ejs') %>
  <title>Soundflow - Home</title>
<%- include('./partials/nav.ejs') %>
</head>
<body>
  <header class="hero-section">
    <div class="hero-content">
      <h1>Welcome to Soundflow üéµ</h1>
      <p>Your ultimate destination for discovering and enjoying music.</p>
    </div>
  </header>

  <main>
    <!-- Trending Songs Section -->
    <div class="trending-section" id="trending-section">
      <h2>Trending Songs üî•</h2>
      <div class="music-grid">
        <% if (trendingSongs && trendingSongs.length > 0) { %>
          <% trendingSongs.forEach(song => { %>
            <div class="music-card" data-song='<%= JSON.stringify(song).replace(/'/g, "&#39;").replace(/"/g, "&quot;") %>'>
              <img src="<%= song.snippet.thumbnails.medium.url %>" alt="<%= song.snippet.title %>" />
              <p><%= song.snippet.title %></p>
            </div>
          <% }) %>
        <% } else { %>
          <p>No trending songs available at the moment.</p>
        <% } %>
      </div>
    </div>

    <!-- YouTube Search Section -->
    <div class="search-section">
      <div class="search-bar">
        <input type="text" id="searchQuery" placeholder="Search for videos..." />
        <button onclick="searchYouTube()">Search</button>
      </div>
    </div>

    <div id="results" class="music-grid"></div>
  </main>

  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-links">
        <a href="/about">About</a>
        <a href="/contact">Contact</a>
        <a href="/privacy">Privacy Policy</a>
        <a href="/terms">Terms of Service</a>
      </div>
      <p class="footer-copy">&copy; <%= new Date().getFullYear() %> Soundflow. All rights reserved.</p>
    </div>
  </footer>

  <script>
    async function searchYouTube() {
      const query = document.getElementById("searchQuery").value;
      if (!query) return;

      try {
        const trendingSection = document.getElementById("trending-section");
        if (trendingSection) trendingSection.style.display = "none";
        const response = await fetch(`/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        let output = "";
        if (data.items && data.items.length > 0) {
          data.items.forEach(item => {
            const videoId = item.id?.videoId;
            if (!videoId) return;
            output += `
              <div class="music-card" data-song='${JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, "&quot;")}'>

                <iframe width="100%" height="150" src="https://www.youtube.com/embed/${item.id.videoId}" frameborder="0" allowfullscreen></iframe>
                <p>${item.snippet.title}</p>
                <div class="heart" id="heart">‚ô°</div>
              </div>
            `;
          });
        } else {
          output = "<p>No results found.</p>";
        }

        document.getElementById("results").innerHTML = output;
      } catch (error) {
        console.error("Error:", error);
      }
    }

    document.getElementById("results").addEventListener("click", async function (e) {
      if (e.target && e.target.classList.contains("heart")) {
        e.target.classList.toggle("active");
        const isActive = e.target.classList.contains("active");
        e.target.textContent = isActive ? "‚ù§Ô∏è" : "‚ô°";

        const songCard = e.target.closest(".music-card");
        const song = JSON.parse(songCard.getAttribute("data-song"));

        try {
          if (isActive) {
            const res = await fetch("/favorites", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(song)
            });
            const data = await res.json();
            alert(data.message || "Added to favorites ‚ù§Ô∏è");
          } else {
            const res = await fetch(`/favorites/${song.id.videoId || song.id}`, {
              method: "DELETE"
            });
            const data = await res.json();
            alert(data.message || "Removed from favorites ‚ô°");
          }
        } catch (err) {
          console.error("Error updating favorites:", err);
          alert("‚ö†Ô∏è Something went wrong. Try again.");
        }
      }
    });
  </script>
</body>
</html>
